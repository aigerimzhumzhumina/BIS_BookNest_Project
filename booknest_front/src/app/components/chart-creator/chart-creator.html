<app-header></app-header>

<div class="chart-creator-container">
  <div class="chart-creator-content">
    <div class="tabs-header">
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'create'"
        (click)="switchTab('create')">
        {{ 'chart.createNew' | translate }}
      </button>
      <button 
        class="tab-button" 
        [class.active]="activeTab === 'manage'"
        (click)="switchTab('manage')">
        {{ 'chart.myCharts' | translate }}: ({{ userCharts.length }})
      </button>
    </div>

    <!-- Create Chart Tab -->
    @if (activeTab === 'create') {
      <div class="create-chart-section">
        <h1>
          @if (editingChartId) {
            <span>{{ 'chart.editTitle' | translate }}</span>
          } @else {
            <span>{{ 'chart.createNewTitle' | translate }}</span>
          }
        </h1>
        <p class="section-description">
          {{ 'chart.description' | translate }}
        </p>

        <div class="chart-form">
          <!-- Cover Upload -->
          <div class="cover-upload-section">
            <label class="cover-label">{{ 'chart.coverLabel' | translate }}</label>
            <div class="cover-preview-wrapper">
              @if (chartCoverPreview) {
                <img [src]="chartCoverPreview" alt="Chart cover" class="cover-preview">
              } @else {
                <div class="cover-placeholder">
                  <span class="placeholder-icon">üñºÔ∏è</span>
                  <span class="placeholder-text">{{ 'chart.uploadCover' | translate }}</span>
                </div>
              }
              <label class="cover-upload-btn">
                <input type="file" accept="image/*" (change)="onCoverChange($event)">
                <span>{{ 'chart.selectImage' | translate }}</span>
              </label>
            </div>
          </div>

          <!-- Chart Info -->
          <div class="form-group">
            <label>{{ 'chart.titleLabel' | translate }} *</label>
            <input 
              type="text" 
              [(ngModel)]="chartTitle" 
              placeholder="{{ 'chart.titlePlaceholder' | translate }}"
              class="form-input">
          </div>

          <div class="form-group">
            <label>{{ 'chart.descriptionLabel' | translate }}</label>
            <textarea 
              [(ngModel)]="chartDescription" 
              placeholder="{{ 'chart.descriptionPlaceholder' | translate }}"
              class="form-textarea"
              rows="4"></textarea>
          </div>

          <div class="form-group checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="isPublic">
              <span>{{ 'chart.makePublic' | translate }}</span>
            </label>
          </div>

          <!-- Books Selection -->
          <div class="books-selection-section">
            <div class="books-header">
              <h3>{{ 'chart.booksInChart' | translate }} ({{ selectedBooks.length }})</h3>
              <button class="btn-add-book" (click)="toggleBookSearch()">
                {{ 'chart.addBook' | translate }}
              </button>
            </div>

            @if (showBookSearch) {
              <div class="book-search-panel">
                <div class="search-input-wrapper">
                  <input 
                    type="text" 
                    [(ngModel)]="searchQuery" 
                    (input)="searchBooks()"
                    placeholder="{{ 'chart.searchBook' | translate }}"
                    class="search-input">
                </div>

                @if (isSearching) {
                  <div class="search-loading">
                    <div class="small-spinner"></div>
                    <span>{{ 'chart.searching' | translate }}</span>
                  </div>
                } @else if (searchResults.length > 0) {
                  <div class="search-results">
                    @for (book of searchResults; track book.id) {
                      <div class="search-result-item" (click)="addBookToChart(book)">
                        <img [src]="book.cover" [alt]="book.title" class="result-cover">
                        <div class="result-info">
                          <h4>{{ book.title }}</h4>
                          <p>{{ book.author }}</p>
                        </div>
                        <button class="btn-add-result">+</button>
                      </div>
                    }
                  </div>
                }
              </div>
            }

            @if (selectedBooks.length > 0) {
              <div class="selected-books-grid">
                @for (book of selectedBooks; track book.id) {
                  <div class="selected-book-card">
                    <button class="btn-remove-book" (click)="removeBookFromChart(book.id)">‚úï</button>
                    <img [src]="book.cover" [alt]="book.title">
                    <div class="book-info">
                      <h4>{{ book.title }}</h4>
                      <p>{{ book.author }}</p>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="empty-books-state">
                <p>{{ 'chart.addBooksToChart' | translate }}</p>
              </div>
            }
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button 
              class="btn-save-chart" 
              (click)="createChart()"
              [disabled]="isSaving || !chartTitle.trim()">
              @if (isSaving) {
                <span>{{ 'chart.saving' | translate }}</span>
              } @else if (editingChartId) {
                <span>{{ 'chart.saveChanges' | translate }}</span>
              } @else {
                <span>{{ 'chart.save' | translate }}</span>
              }
            </button>
            <button class="btn-reset" (click)="resetForm()">
              {{ 'chart.reset' | translate }}
            </button>
          </div>
        </div>
      </div>
    }

    <!-- Manage Charts Tab -->
    @if (activeTab === 'manage') {
      <div class="manage-charts-section">
        <h1>{{ 'chart.manageTitle' | translate }}</h1>
        <p class="section-description">{{ 'chart.manageDescription' | translate }}</p>

        @if (userCharts.length > 0) {
          <div class="charts-grid">
            @for (chart of userCharts; track chart.id) {
              <div class="chart-card">
                <div class="chart-cover">
                  @if (chart.cover_image) {
                    <img [src]="chart.cover_image" [alt]="chart.title">
                  } @else {
                    <div class="chart-placeholder">
                      <span>‚ú¶</span>
                    </div>
                  }
                  <div class="chart-overlay">
                    <button class="btn-edit-chart" (click)="editChart(chart)">‚úê</button>
                    <button class="btn-delete-chart" (click)="deleteChart(chart.id)">üóëÔ∏è</button>
                  </div>
                </div>
                <div class="chart-info">
                  <h3>{{ chart.title }}</h3>
                  @if (chart.description) {
                    <p class="chart-description">{{ chart.description }}</p>
                  }
                  <div class="chart-meta">
                    <span class="book-count">‚ú¶ {{ chart.books.length }} {{ 'chart.books' | translate }}</span>
                    @if (chart.is_public) {
                      <span class="public-badge">{{ 'chart.public' | translate }}</span>
                    }
                  </div>
                </div>
              </div>
            }
          </div>
        } @else {
          <div class="empty-state">
            <div class="empty-icon">‚ú¶</div>
            <h2>{{ 'chart.noCharts' | translate }}</h2>
            <p>{{ 'chart.createFirst' | translate }}</p>
            <button class="btn-primary" (click)="switchTab('create')">
              {{ 'chart.createNew' | translate }}
            </button>
          </div>
        }
      </div>
    }
  </div>
</div>